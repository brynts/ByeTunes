name: Build

on:
  workflow_dispatch:
  push:
    branches: [ build ]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    env:
      SCHEME: MusicManager
      CONFIGURATION: Release
      IPHONEOS_DEPLOYMENT_TARGET: "18.0"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Clone idevice repo
        run: git clone https://github.com/jkcoxson/idevice.git

      - name: Build idevice for iOS
        working-directory: idevice
        run: |
          export IPHONEOS_DEPLOYMENT_TARGET=18.0
          export SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
          export CC="$(xcrun --sdk iphoneos -f clang)"
          cargo build --release --target aarch64-apple-ios

      - name: Copy idevice artifacts
        run: |
          set -e
          mkdir -p MusicManager
          LIB=$(find idevice/target/aarch64-apple-ios/release -type f -name "*idevice*.a" | head -n 1)
          HDR=$(find idevice -type f -name "idevice.h" | head -n 1)
          if [ -z "$LIB" ] || [ -z "$HDR" ]; then
            echo "Error: Could not find libidevice*.a or idevice.h"
            exit 1
          fi
          cp "$LIB" MusicManager/libidevice_ffi.a
          cp "$HDR" MusicManager/idevice.h

      - name: Create Bridging Header
        run: |
          cat > MusicManager/Bridging-Header.h << 'EOF'
          #import "idevice.h"
          EOF
      
      - name: Build the app
        run: |
          set -o pipefail
          xcodebuild \
            -project MusicManager.xcodeproj \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            LIBRARY_SEARCH_PATHS="$PWD/MusicManager" \
            OTHER_LDFLAGS="-lidevice_ffi -ObjC" \
            DEBUG_INFORMATION_FORMAT=dwarf-with-dsym \
            build | xcpretty || exit ${PIPESTATUS[0]}

      - name: Package IPA
        run: |
          APP=$(find ~/Library/Developer/Xcode/DerivedData -maxdepth 4 -type d -name "MusicManager.app" | head -n 1)
          if [ -z "$APP" ]; then
            echo "Error: MusicManager.app not found"
            exit 1
          fi
          mkdir -p Payload
          cp -R "$APP" Payload/
          zip -r ByeTunes.ipa Payload
          ls -lh ByeTunes.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ByeTunes-ipa
          path: ByeTunes.ipa

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: build-${{ github.run_number }}
          name: ByeTunes CI Build ${{ github.run_number }}
          files: ByeTunes.ipa
