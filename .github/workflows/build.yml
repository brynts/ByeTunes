name: Build

on:
  workflow_dispatch:
  push:
    branches: [ build ]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    env:
      SCHEME: MusicManager
      CONFIGURATION: Release
      IPHONEOS_DEPLOYMENT_TARGET: "18.0"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Clone idevice repo
        run: git clone https://github.com/jkcoxson/idevice.git

      - name: Build idevice for iOS
        working-directory: idevice
        run: |
          export IPHONEOS_DEPLOYMENT_TARGET=18.0
          export SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
          export CC="$(xcrun --sdk iphoneos -f clang)"
          cargo build --release --target aarch64-apple-ios

      - name: Copy idevice artifacts
        run: |
          set -e
          mkdir -p MusicManager
          LIB=$(find idevice/target/aarch64-apple-ios/release -type f -name "*idevice*.a" | head -n 1)
          HDR=$(find idevice -type f -name "idevice.h" | head -n 1)
          if [ -z "$LIB" ] || [ -z "$HDR" ]; then
            echo "Error: Could not find libidevice*.a or idevice.h"
            exit 1
          fi
          cp "$LIB" MusicManager/libidevice_ffi.a
          cp "$HDR" MusicManager/idevice.h
          ls -la MusicManager/

      - name: Create Bridging Header
        run: |
          cat > MusicManager/Bridging-Header.h << 'EOF'
          #import "idevice.h"
          EOF

      - name: Patch iDeviceManager.swift for UInt32 types (AFC fixes)
        run: |
          set -e
          file="MusicManager/iDeviceManager.swift"
          if [ ! -f "$file" ]; then
            echo "Error: $file not found!"
            exit 1
          fi

          echo "Before patching:"
          grep -A 10 -B 5 "afc_file_read" "$file" || echo "No afc_file_read found yet"

          # Change var length: Int → UInt32
          sed -i '' 's/var length: Int/var length: UInt32/g' "$file"

          # Add missing bytes_read param to afc_file_read (assume it's needed; adjust if binding differs)
          sed -i '' 's/afc_file_read(file, &dataPtr, &length)/afc_file_read(file, &dataPtr, &length, nil)/g' "$file"  # nil if optional

          # Cast length to UInt32 in calls
          sed -i '' 's/afc_file_read(\([^,]*,\ [^,]*,\ [^,]*,\ length\)/afc_file_read(\1, UInt32(length))/g' "$file"
          sed -i '' 's/afc_file_read(\([^,]*,\ [^,]*,\ [^,]*,\ [^,]*,\ length\)/afc_file_read(\1, UInt32(length))/g' "$file"  # If 5 args

          # For afc_file_write, cast data.count to UInt32 and ensure Int → UInt32
          sed -i '' 's/afc_file_write(\([^,]*,\ [^,]*,\ data.count\)/afc_file_write(\1, UInt32(data.count))/g' "$file"
          sed -i '' 's/afc_file_write(\([^,]*,\ [^,]*,\ length\)/afc_file_write(\1, UInt32(length))/g' "$file"

          # Fix pointer types if &length is passed
          sed -i '' 's/&length/UnsafeMutablePointer<UInt32>(&length)/g' "$file"

          echo "After patching:"
          grep -A 10 -B 5 "afc_file_read" "$file" || echo "No matches after patch"

          echo "Full diff:"
          git diff "$file" || echo "No diff"

      - name: Build the app
        run: |
          set -o pipefail
          xcodebuild \
            -project MusicManager.xcodeproj \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            LIBRARY_SEARCH_PATHS="$PWD/MusicManager" \
            OTHER_LDFLAGS="-lidevice_ffi -ObjC" \
            build | xcpretty || exit ${PIPESTATUS[0]}

      - name: Package IPA
        run: |
          APP=$(find ~/Library/Developer/Xcode/DerivedData -maxdepth 4 -type d -name "MusicManager.app" | head -n 1)
          if [ -z "$APP" ]; then
            echo "Error: MusicManager.app not found"
            exit 1
          fi
          mkdir -p Payload
          cp -R "$APP" Payload/
          zip -r ByeTunes.ipa Payload
          ls -lh ByeTunes.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ByeTunes-ipa
          path: ByeTunes.ipa

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: build-${{ github.run_number }}
          name: ByeTunes CI Build ${{ github.run_number }}
          files: ByeTunes.ipa