name: Build

on:
  workflow_dispatch:
  push:
    branches: [ build ]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    env:
      SCHEME: MusicManager
      CONFIGURATION: Release
      IPHONEOS_DEPLOYMENT_TARGET: "18.0"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Clone idevice repo
        run: git clone https://github.com/jkcoxson/idevice.git

      - name: Build idevice for iOS
        working-directory: idevice
        run: |
          export IPHONEOS_DEPLOYMENT_TARGET=18.0
          export SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
          export CC="$(xcrun --sdk iphoneos -f clang)"
          cargo build --release --target aarch64-apple-ios

      - name: Copy idevice artifacts
        run: |
          set -e
          mkdir -p MusicManager
          LIB=$(find idevice/target/aarch64-apple-ios/release -type f -name "*idevice*.a" | head -n 1)
          HDR=$(find idevice -type f -name "idevice.h" | head -n 1)
          if [ -z "$LIB" ] || [ -z "$HDR" ]; then
            echo "Error: Could not find libidevice*.a or idevice.h"
            exit 1
          fi
          cp "$LIB" MusicManager/libidevice_ffi.a
          cp "$HDR" MusicManager/idevice.h
          ls -la MusicManager/

      - name: Create Bridging Header
        run: |
          cat > MusicManager/Bridging-Header.h << 'EOF'
          #import "idevice.h"
          EOF

      - name: Precise patching for AFC type issues
        run: |
          set -e
          file="MusicManager/iDeviceManager.swift"
          if [ ! -f "$file" ]; then
            echo "Error: $file not found!"
            exit 1
          fi

          echo "=== BEFORE PATCHING ==="
          grep -n -C 5 "afc_file_read" "$file" || echo "No afc_file_read found"
          grep -n -C 5 "afc_file_write" "$file" || echo "No afc_file_write found"

          # 1. Change var length declaration to UInt32 (safe, non-destructive)
          sed -i '' 's/var length: *Int/var length: UInt32/' "$file"

          # 2. Fix afc_file_write: cast data.count to UInt32 (only if no cast yet)
          sed -i '' '/afc_file_write(/ s/data\.count/UInt32(data.count)/' "$file"

          # 3. Fix afc_file_read: if length is last arg, cast to UInt32(length)
          #    This matches common pattern: afc_file_read(..., length)
          sed -i '' '/afc_file_read(/ s/,\ *length)/, UInt32(length))/' "$file"

          # 4. If &length is used (out param), change to proper pointer cast
          sed -i '' 's/,\ *\&length)/, UnsafeMutablePointer<UInt32>(&length))/' "$file"

          # 5. Remove any accidental duplications from previous bad patches
          sed -i '' '/afc_file_read(/ s/afc_file_read.*afc_file_read/afc_file_read/' "$file"
          sed -i '' 's/lengthlength/length/g' "$file"

          # 6. Fix broken trailing closure if patch damaged it
          sed -i '' 's/async {/async {/g' "$file"

          echo "=== AFTER PATCHING ==="
          grep -n -C 5 "afc_file_read" "$file" || echo "No afc_file_read after patch"
          grep -n -C 5 "afc_file_write" "$file" || echo "No afc_file_write after patch"

          echo "=== DIFF SUMMARY ==="
          git diff "$file" | head -n 40 || echo "No diff or git not tracking"

      - name: Build the app
        run: |
          set -o pipefail
          xcodebuild \
            -project MusicManager.xcodeproj \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            LIBRARY_SEARCH_PATHS="$PWD/MusicManager" \
            OTHER_LDFLAGS="-lidevice_ffi -ObjC" \
            DEBUG_INFORMATION_FORMAT=dwarf-with-dsym \
            build | xcpretty || exit ${PIPESTATUS[0]}

      - name: Package IPA
        run: |
          APP=$(find ~/Library/Developer/Xcode/DerivedData -maxdepth 4 -type d -name "MusicManager.app" | head -n 1)
          if [ -z "$APP" ]; then
            echo "Error: MusicManager.app not found"
            exit 1
          fi
          mkdir -p Payload
          cp -R "$APP" Payload/
          zip -r ByeTunes.ipa Payload
          ls -lh ByeTunes.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ByeTunes-ipa
          path: ByeTunes.ipa

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: build-${{ github.run_number }}
          name: ByeTunes CI Build ${{ github.run_number }}
          files: ByeTunes.ipa
