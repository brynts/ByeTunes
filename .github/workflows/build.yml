name: Build

on:
  workflow_dispatch:
  push:
    branches: [ build ]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    env:
      SCHEME: MusicManager
      CONFIGURATION: Release
      IPHONEOS_DEPLOYMENT_TARGET: "18.0"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Clone idevice repo
        run: git clone https://github.com/jkcoxson/idevice.git

      - name: Build idevice for iOS
        working-directory: idevice
        run: |
          export IPHONEOS_DEPLOYMENT_TARGET=18.0
          export SDKROOT="$(xcrun --sdk iphoneos --show-sdk-path)"
          export CC="$(xcrun --sdk iphoneos -f clang)"
          cargo build --release --target aarch64-apple-ios

      - name: Copy idevice artifacts
        run: |
          set -e
          mkdir -p MusicManager
          LIB=$(find idevice/target/aarch64-apple-ios/release -type f -name "*idevice*.a" | head -n 1)
          HDR=$(find idevice -type f -name "idevice.h" | head -n 1)
          if [ -z "$LIB" ] || [ -z "$HDR" ]; then
            echo "Error: Could not find libidevice*.a or idevice.h"
            exit 1
          fi
          cp "$LIB" MusicManager/libidevice_ffi.a
          cp "$HDR" MusicManager/idevice.h
          ls -la MusicManager/

      - name: Create Bridging Header
        run: |
          cat > MusicManager/Bridging-Header.h << 'EOF'
          #import "idevice.h"
          EOF

      - name: Precise patching for AFC type issues
        run: |
          set -e
          file="MusicManager/iDeviceManager.swift"
          if [ ! -f "$file" ]; then
            echo "Error: $file not found!"
            exit 1
          fi

          echo "=== BEFORE PATCHING ==="
          grep -n "afc_file_read" "$file" || echo "No afc_file_read found"

          # 1. Fix ambiguous withUnsafeBytes (explicitly add type to closure)
          # This fixes: "generic parameter 'ContentType' could not be inferred"
          sed -i '' 's/data.withUnsafeBytes { buffer in/data.withUnsafeBytes { (buffer: UnsafeRawBufferPointer) in/g' "$file"

          # 2. Change var length declaration to UInt32 (safe)
          sed -i '' 's/var length: *Int/var length: UInt32/' "$file"

          # 3. For afc_file_write: Add missing nil param
          sed -i '' 's/afc_file_write(file, base, data.count)/afc_file_write(file, base, UInt32(data.count), nil)/' "$file"

          # 4. For afc_file_read: Add missing nil param AND handle the '&' pointer symbol
          # We check for '&length' specifically now
          sed -i '' 's/afc_file_read(file, &dataPtr, &length)/afc_file_read(file, &dataPtr, UInt32(length), nil)/' "$file"
          # Fallback: maintain the old pattern just in case it appears without '&' elsewhere
          sed -i '' 's/afc_file_read(file, &dataPtr, length)/afc_file_read(file, &dataPtr, UInt32(length), nil)/' "$file"

          # 5. Clean up any broken pointer casts
          sed -i '' 's/UnsafeMutablePointer<UInt32>(, /UnsafeMutablePointer<UInt32>(/' "$file"
          sed -i '' 's/&length length/UnsafeMutablePointer<UInt32>(&length)/' "$file" || true

          echo "=== AFTER PATCHING ==="
          grep -n "afc_file_read" "$file" || echo "No afc_file_read after patch"
          
          echo "=== DIFF SUMMARY ==="
          git diff "$file" | head -n 40 || echo "No diff or git not tracking"

      - name: Build the app
        run: |
          set -o pipefail
          xcodebuild \
            -project MusicManager.xcodeproj \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            LIBRARY_SEARCH_PATHS="$PWD/MusicManager" \
            OTHER_LDFLAGS="-lidevice_ffi -ObjC" \
            DEBUG_INFORMATION_FORMAT=dwarf-with-dsym \
            build | xcpretty || exit ${PIPESTATUS[0]}

      - name: Package IPA
        run: |
          APP=$(find ~/Library/Developer/Xcode/DerivedData -maxdepth 4 -type d -name "MusicManager.app" | head -n 1)
          if [ -z "$APP" ]; then
            echo "Error: MusicManager.app not found"
            exit 1
          fi
          mkdir -p Payload
          cp -R "$APP" Payload/
          zip -r ByeTunes.ipa Payload
          ls -lh ByeTunes.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ByeTunes-ipa
          path: ByeTunes.ipa

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: build-${{ github.run_number }}
          name: ByeTunes CI Build ${{ github.run_number }}
          files: ByeTunes.ipa
